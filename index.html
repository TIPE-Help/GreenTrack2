<div class="card">
        <h2>Commerçant</h2>
        <div id="reader"></div>
        <button class="btn" style="background:#333;" onclick="demarrerScanner()">ACTIVER SCANNER</button>
        <div id="scan-result" style="margin-top:15px; padding:10px; border-radius:8px; display:none;"></div>
    </div>

    <script>
// --- CONFIGURATION SUPABASE ---
const SUPABASE_URL = "https://jfejbhaxxbdrIbbysgpi.supabase.co"; 
const SUPABASE_KEY = "TON_CODE_ANON_ICI"; // <--- BIEN VÉRIFIER CETTE CLÉ

// On change le nom ici pour éviter le bug : supabaseAdmin au lieu de supabase
const supabaseAdmin = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// 1. GÉNÉRER ET ENREGISTRER
async function creerCodeDansBase() {
    const idUnique = "GT-LILLE-" + Math.floor(Math.random() * 100000);
    console.log("Tentative de création :", idUnique);

    try {
        const { error } = await supabaseAdmin
            .from('recompenses') // VÉRIFIE QUE TA TABLE S'APPELLE BIEN recompenses
            .insert([{ code_texte: idUnique, est_utilise: false }]);

        if (error) {
            alert("Erreur Supabase : " + error.message);
            return;
        }

        // Affichage du QR Code
        document.getElementById("qrcode").innerHTML = "";
        new QRCode(document.getElementById("qrcode"), {
            text: idUnique,
            width: 150,
            height: 150
        });
        alert("Code enregistré et généré !");

    } catch (err) {
        alert("Erreur système : " + err.message);
    }
}

// 2. SCANNER ET ACTIVER CAMÉRA
function demarrerScanner() {
    // Vérification si on est bien en HTTPS (obligatoire pour la caméra)
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        alert("La caméra nécessite une connexion sécurisée (HTTPS). Utilise ton lien GitHub Pages !");
        return;
    }

    const scanner = new Html5Qrcode("reader");
    
    scanner.start(
        { facingMode: "environment" }, 
        { fps: 10, qrbox: 250 }, 
        async (decodedText) => {
            alert("Scan réussi : " + decodedText);
            scanner.stop();
            verifierCodeDansBase(decodedText);
        },
        (err) => { /* lecture en cours... */ }
    ).catch(err => alert("Impossible d'ouvrir la caméra : " + err));
}

// 3. VÉRIFICATION
async function verifierCodeDansBase(texteScanne) {
    const resultDiv = document.getElementById("scan-result");
    resultDiv.style.display = "block";
    resultDiv.innerHTML = "Vérification...";

    const { data, error } = await supabaseAdmin
        .from('recompenses')
        .select('*')
        .eq('code_texte', texteScanne)
        .eq('est_utilise', false)
        .single();

    if (data) {
        resultDiv.style.background = "#d8f3dc";
        resultDiv.innerHTML = "✅ VALIDE !";
        // Marquer comme utilisé
        await supabaseAdmin
            .from('recompenses')
            .update({ est_utilise: true })
            .eq('code_texte', texteScanne);
    } else {
        resultDiv.style.background = "#ffccd5";
        resultDiv.innerHTML = "❌ INVALIDE ou DÉJÀ UTILISÉ";
    }
    
}
